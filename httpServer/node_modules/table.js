var db= require("db");
var httpMsg=require("httpMsg")
var mysql= require("mysql");

exports.getUserSettings=function(req, resp,username){
    var sql="SELECT * FROM RidingMechanic.user WHERE username=("+mysql.escape(username)+")";
    console.log(sql);
    db.excuteSql(sql,function(data, err){
        if(err){
            httpMsg.show500(req,resp,err);
        }else{
            httpMsg.sendJson(req,resp,data);
        }
    })
};

exports.getTrip=function(req, resp,userID){
    var sql="SELECT * FROM RidingMechanic.trip WHERE userID=("+mysql.escape(userID)+")";
    console.log(sql);
    db.excuteSql(sql,function(data, err){
        if(err){
            httpMsg.show500(req,resp,err);
        }else{
            httpMsg.sendJson(req,resp,data);
        }
    })
};

exports.getUserList=function(req, resp){
    var sql="SELECT userID, username,cast(AES_Decrypt(password,username) AS CHAR) FROM RidingMechanic.user";
    console.log(sql);
    db.excuteSql(sql,function(data, err){
        if(err){
            httpMsg.show500(req,resp,err);
        }else{
            httpMsg.sendJson(req,resp,data);
        }
    })
};

exports.addUser=function(req,resp,reqBody){
    try{
        if(!reqBody) throw new Error("Input not valid");
        var data=JSON.parse(reqBody);
        if(data){
            var sql="Insert INTO RidingMechanic.user(username,password) VALUES"
            +"("+mysql.escape(data.username)+","+"AES_Encrypt"+"("+mysql.escape(data.password)+","+mysql.escape(data.username)+")"+")";
            console.log(sql);
            db.excuteSql(sql,function(data,err){
                if(err){
                    httpMsg.show500(req,resp,err);
                }else{
                    httpMsg.send200(req,resp); 
                }
            });
        }
        else{
            throw new Error("Input not valid");
        }
    }
    catch(error){
        httpMsg.show500(req,resp,error);
    }
};

exports.addTrip=function(req,resp,reqBody){
    try{
        if(!reqBody) throw new Error("Input not valid");
        var data=JSON.parse(reqBody);
        if(data){
            var sql="Insert INTO RidingMechanic.trip(userID,startDateTime,endDateTime,drivingDistance,averageMPG,averageSpeed,fuelCost,sharpAccelerationTime,sharpBrakingTime) VALUES"
            +"("+mysql.escape(data.userID)+","+mysql.escape(data.startDateTime)+","+mysql.escape(data.endDateTime)+","
            +mysql.escape(data.drivingDistance)+","+mysql.escape(data.averageMPG)+","+mysql.escape(data.averageSpeed)+","
            +mysql.escape(data.fuelCost)+","+mysql.escape(data.sharpAccelerationTime)+","+mysql.escape(data.sharpBrakingTime)+")";
            console.log(sql);
            db.excuteSql(sql,function(data,err){
                if(err){
                    httpMsg.show500(req,resp,err);
                }else{
                    httpMsg.send200(req,resp); 
                }
            });
        }
        else{
            throw new Error("Input not valid");
        }
    }
    catch(error){
        httpMsg.show500(req,resp,error);
    }
};

exports.updateUser=function(req,resp,reqBody){
    try{
        if(!reqBody) throw new Error("Input not valid");
        var data=JSON.parse(reqBody);
        if(data){  
            if(!data.username) throw new Error("Username not provided")
            if(data.totalAlertSwitch){
                var sql="UPDATE RidingMechanic.user SET totalAlertSwitch=("+mysql.escape(data.totalAlertSwitch)+")"
                +", speedAlertSwitch=("+mysql.escape(data.speedAlertSwitch)+")"
                +", speedLimit=("+mysql.escape(data.speedLimit)+")"
                +", tiredDrivingAlertSwitch=("+mysql.escape(data.tiredDrivingAlertSwitch)+")"
                +", tiredDrivingHour=("+mysql.escape(data.tiredDrivingHour)+")"
                +", waterTemperatureAlertSwitch=("+mysql.escape(data.waterTemperatureAlertSwitch)+")"
                +", waterTemperatureLimit=("+mysql.escape(data.waterTemperatureLimit)+")"
                +", fuelPrice=("+mysql.escape(data.fuelPrice)+")"
                +"WHERE username=("+mysql.escape(data.username)+")";
            }else{
                var sql="UPDATE RidingMechanic.user SET password= AES_Encrypt("+mysql.escape(data.password)+","+mysql.escape(data.username)
                +")WHERE username=("+mysql.escape(data.username)+")";
            }
            
            console.log(sql);
            db.excuteSql(sql,function(data,err){
                if(err){
                    httpMsg.show500(req,resp,err);
                }else{
                    httpMsg.send200(req,resp); 
                }
            });
        }
        else{
            throw new Error("Input not valid");
        }
    }
    catch(error){
        httpMsg.show500(req,resp,error);
    }
};